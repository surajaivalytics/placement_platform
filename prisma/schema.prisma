// Prisma schema
// https://pris.ly/d/prisma-schema



generator client {
  provider = "prisma-client-js"
}

datasource db {
        
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("user")
  password      String?

  bio         String?
  phone       String?
  address     String?
  coverImage  String?
  accountType String?   @default("Regular")
  autoPayout  Boolean   @default(false)

  tenthPercentage   Float?
  twelfthPercentage Float?
  graduationCGPA    Float?
  backlogs          Int?     @default(0)
  gapYears          Int?     @default(0)
  gapDuringGrad     Boolean? @default(false)

  accounts              Account[]
  sessions              Session[]
  results               Result[]
  placementApplications PlacementApplication[]
  interviewSessions     InterviewSession[]
  monitoringEvents      MonitoringEvent[]
  mockDrives            MockDriveSession[]
  userSubtopicProgress  UserSubtopicProgress[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Test {
  id          String   @id @default(cuid())
  title       String
  description String?
  duration    Int
  difficulty  String
  type        String?  @default("topic")
  company     String?
  topic       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions   Question[]
  results     Result[]
  assignments TestAssignment[]
  subtopics   Subtopic[]
}

model Question {
  id         String  @id @default(cuid())
  testId     String
  text       String
  type       String  @default("multiple-choice")
  category   String?
  difficulty String?
  metadata   String? @db.Text
  subtopicId String?
  order      Int?

  options  Option[]
  test     Test      @relation(fields: [testId], references: [id], onDelete: Cascade)
  subtopic Subtopic? @relation(fields: [subtopicId], references: [id], onDelete: Cascade)

  @@index([subtopicId])
}

model Option {
  id         String  @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean @default(false)

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Result {
  id               String   @id @default(cuid())
  userId           String
  testId           String
  score            Int
  total            Int
  aiFeedback       String?  @db.Text
  createdAt        DateTime @default(now())

  monitoringEvents MonitoringEvent[]
  user             User @relation(fields: [userId], references: [id], onDelete: Cascade)
  test             Test @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model UserSubtopicProgress {
  id         String  @id @default(cuid())
  userId     String
  subtopicId String

  score      Int?
  total      Int?
  percentage Float?
  attempted  Boolean @default(false)
  completed  Boolean @default(false)
  answers    String? @db.Text
  timeSpent  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subtopic Subtopic @relation(fields: [subtopicId], references: [id], onDelete: Cascade)

  @@unique([userId, subtopicId])
  @@index([userId])
  @@index([subtopicId])
}

model Subtopic {
  id             String   @id @default(cuid())
  testId         String
  name           String
  description    String?
  totalQuestions Int      @default(0)
  order          Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  test                 Test @relation(fields: [testId], references: [id], onDelete: Cascade)
  questions            Question[]
  userSubtopicProgress UserSubtopicProgress[]

  @@index([testId])
}

model TestAssignment {
  id         String   @id @default(cuid())
  testId     String
  userId     String
  assignedBy String
  isPublic   Boolean  @default(false)
  createdAt  DateTime @default(now())

  test Test @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, userId])
}

model MonitoringEvent {
  id            String   @id @default(cuid())
  userId        String
  testType      String?
  violationType String
  details       String?
  timestamp     DateTime @default(now())

  resultId String?
  result   Result? @relation(fields: [resultId], references: [id], onDelete: Cascade)
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InterviewSession {
  id             String   @id @default(cuid())
  userId         String
  interviewType  String
  companyType    String
  startedAt      DateTime @default(now())
  endedAt        DateTime?
  scores         Json?
  feedback       String?  @db.Text
  overallVerdict String?
  recordingUrl   String?
  transcript     String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PlacementApplication {
  id        String   @id @default(cuid())
  userId    String
  company   String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MockDriveSession {
  id           String   @id @default(cuid())
  userId       String
  company      String
  currentRound Int      @default(1)
  status       String   @default("IN_PROGRESS")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
