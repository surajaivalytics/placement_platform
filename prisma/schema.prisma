generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                    String                 @id @default(cuid())
  name                  String?
  email                 String?                @unique
  emailVerified         DateTime?
  image                 String?
  role                  String                 @default("user")
  password              String?
  bio                   String?
  phone                 String?
  address               String?
  backlogs              Int?                   @default(0)
  gapDuringGrad         Boolean?               @default(false)
  gapYears              Int?                   @default(0)
  graduationCGPA        Float?
  tenthPercentage       Float?
  twelfthPercentage     Float?
  accountType           String?                @default("Regular")
  autoPayout            Boolean                @default(false)
  coverImage            String?
  accounts              Account[]
  interviewSessions     InterviewSession[]
  mockEnrollments       MockDriveEnrollment[]
  mockDrives            MockDriveSession[]
  monitoringEvents      MonitoringEvent[]
  placementApplications PlacementApplication[]
  results               Result[]
  sessions              Session[]
  submissions           Submissions[]          @relation("userSubmissions")
  testEligibilities     TestEligibility[]      @relation("userTestEligibilities")
  subtopicProgress      UserSubtopicProgress[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model OneTimePassword {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model Test {
  id                  String            @id @default(cuid())
  title               String
  description         String?
  duration            Int
  difficulty          String
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  company             String?
  topic               String?
  type                String?           @default("topic")
  eligibilityCriteria Json?
  assessmentStages    AssessmentStage[]
  questions           Question[]
  results             Result[]
  subtopics           Subtopic[]
  assignments         TestAssignment[]
  eligibilityRecords  TestEligibility[]
}

model TestEligibility {
  id         String   @id @default(cuid())
  userId     String
  testId     String
  isEligible Boolean  @default(false)
  criteria   Json?
  checkedAt  DateTime @default(now())
  test       Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  user       User     @relation("userTestEligibilities", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, testId])
}

model Subtopic {
  id             String                 @id @default(cuid())
  testId         String?
  name           String?
  description    String?
  totalQuestions Int?                   @default(0)
  order          Int?
  roundTitle     String?
  type           String?                @default("assessment")
  questions      Question[]
  test           Test?                  @relation(fields: [testId], references: [id], onDelete: Cascade)
  progress       UserSubtopicProgress[]
}

model Question {
  id         String    @id @default(cuid())
  testId     String
  text       String
  type       String    @default("multiple-choice")
  category   String?
  difficulty String?
  metadata   String?
  order      Int?
  subtopicId String?
  marks      Int       @default(1)
  options    Option[]
  subtopic   Subtopic? @relation(fields: [subtopicId], references: [id])
  test       Test      @relation(fields: [testId], references: [id], onDelete: Cascade)
}

model Option {
  id         String   @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean  @default(false)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Result {
  id               String            @id @default(cuid())
  userId           String
  testId           String
  score            Int
  total            Int
  aiFeedback       String?
  createdAt        DateTime          @default(now())
  details          Json?
  monitoringEvents MonitoringEvent[]
  test             Test              @relation(fields: [testId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSubtopicProgress {
  id         String   @id @default(cuid())
  userId     String
  subtopicId String
  score      Int?
  total      Int?
  percentage Float?
  attempted  Boolean  @default(false)
  completed  Boolean  @default(false)
  answers    String?
  timeSpent  Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  subtopic   Subtopic @relation(fields: [subtopicId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, subtopicId])
  @@index([userId])
  @@index([subtopicId])
}

model TestAssignment {
  id         String   @id @default(cuid())
  testId     String
  userId     String
  assignedBy String
  isPublic   Boolean  @default(false)
  createdAt  DateTime @default(now())
  test       Test     @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, userId])
}

model MonitoringEvent {
  id            String   @id @default(cuid())
  resultId      String?
  timestamp     DateTime @default(now())
  details       String?
  testType      String?
  userId        String
  violationType String?
  eventType     String
  result        Result?  @relation(fields: [resultId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InterviewSession {
  id             String    @id @default(cuid())
  userId         String
  interviewType  String
  companyType    String
  startedAt      DateTime  @default(now())
  endedAt        DateTime?
  scores         Json?
  feedback       String?
  overallVerdict String?
  recordingUrl   String?
  transcript     String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VoiceAssessment {
  id                 String               @id @default(cuid())
  applicationId      String               @unique
  audioUrl           String?
  transcript         String?
  fluencyScore       Float?
  pronunciationScore Float?
  paceScore          Float?
  clarityScore       Float?
  isPassed           Boolean              @default(false)
  feedback           String?
  assessedAt         DateTime?
  createdAt          DateTime             @default(now())
  aiFeedback         Json?
  confidenceScore    Float?
  reviewType         String?              @default("AI_ONLY")
  status             String?              @default("PENDING")
  totalScore         Float?
  application        PlacementApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model PlacementApplication {
  id                String            @id @default(cuid())
  userId            String
  company           String
  status            String
  currentStage      String?
  eligibilityStatus String?
  finalTrack        String?
  finalDecision     String?
  withdrawnAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  candidateId       String?           @unique
  assessmentStages  AssessmentStage[]
  eligibilityCheck  EligibilityCheck?
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  voiceAssessment   VoiceAssessment?
}

model EligibilityCheck {
  id                String               @id @default(cuid())
  applicationId     String               @unique
  tenthPercentage   Float
  twelfthPercentage Float
  graduationCGPA    Float
  backlogs          Int
  gapYears          Int
  gapDuringGrad     Boolean
  isEligible        Boolean
  rejectionReasons  String?
  checkedAt         DateTime             @default(now())
  application       PlacementApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model AssessmentStage {
  id            String               @id @default(cuid())
  applicationId String
  stageName     String
  testId        String?
  score         Int?
  total         Int?
  percentage    Float?
  isPassed      Boolean              @default(false)
  timeSpent     Int?
  submittedAt   DateTime?
  createdAt     DateTime             @default(now())
  application   PlacementApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  test          Test?                @relation(fields: [testId], references: [id])
}

model MockDriveSession {
  id            String   @id @default(cuid())
  userId        String
  company       String
  currentRound  Int      @default(1)
  status        String   @default("IN_PROGRESS")
  round1Score   Float?
  round2Score   Float?
  round3Score   Float?
  lastActiveUrl String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Problem {
  id              Int           @id @default(autoincrement())
  slug            String        @unique
  title           String
  description     String
  type            String
  difficulty      String
  starterTemplate Json?
  testCases       Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  driverCode      Json?
  constraints     String?
  examples        Json?
  expectedSpace   String?
  expectedTime    String?
  submissions     Submissions[]
}

model Submissions {
  id        String   @id @default(cuid())
  problemId Int
  userId    String
  code      String
  language  String
  status    String   @default("Pending")
  createdAt DateTime @default(now())
  problem   Problem  @relation(fields: [problemId], references: [id])
  user      User     @relation("userSubmissions", fields: [userId], references: [id])

  @@unique([userId, problemId, language])
}

model MockCompanyDrive {
  id                  String                @id @default(cuid())
  title               String
  companyName         String
  description         String?
  isLive              Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  eligibilityCriteria Json?
  enrollments         MockDriveEnrollment[]
  rounds              MockRound[]
}

model MockRound {
  id              String              @id @default(cuid())
  driveId         String
  roundNumber     Int
  type            MockRoundType
  title           String
  description     String?
  durationMinutes Int                 @default(60)
  metadata        Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  questions       MockQuestion[]
  drive           MockCompanyDrive    @relation(fields: [driveId], references: [id], onDelete: Cascade)
  roundProgress   MockRoundProgress[]

  @@unique([driveId, roundNumber])
}

model MockQuestion {
  id             String         @id @default(cuid())
  roundId        String
  text           String
  type           String
  options        Json?
  codingMetadata Json?
  points         Int            @default(1)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  round          MockRound      @relation(fields: [roundId], references: [id], onDelete: Cascade)
  responses      MockResponse[]
}

model MockDriveEnrollment {
  id                 String              @id @default(cuid())
  userId             String
  driveId            String
  status             MockDriveStatus     @default(IN_PROGRESS)
  currentRoundNumber Int                 @default(1)
  overallScore       Float               @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  drive              MockCompanyDrive    @relation(fields: [driveId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  roundProgress      MockRoundProgress[]

  @@unique([userId, driveId])
}

model MockRoundProgress {
  id                    String                     @id @default(cuid())
  enrollmentId          String
  roundId               String
  status                MockRoundStatus            @default(PENDING)
  score                 Float                      @default(0)
  totalQuestions        Int                        @default(0)
  answeredQuestions     Int                        @default(0)
  aiFeedback            String?
  proctoringLogs        String?
  startedAt             DateTime?
  completedAt           DateTime?
  interviewInteractions MockInterviewInteraction[]
  responses             MockResponse[]
  enrollment            MockDriveEnrollment        @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  round                 MockRound                  @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, roundId])
}

model MockResponse {
  id              String            @id @default(cuid())
  roundProgressId String
  questionId      String
  answer          String?
  language        String?
  isCorrect       Boolean           @default(false)
  score           Float             @default(0)
  passedCases     Int               @default(0)
  totalCases      Int               @default(0)
  lastSavedAt     DateTime          @default(now())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  question        MockQuestion      @relation(fields: [questionId], references: [id], onDelete: Cascade)
  roundProgress   MockRoundProgress @relation(fields: [roundProgressId], references: [id], onDelete: Cascade)

  @@unique([roundProgressId, questionId])
}

model MockInterviewInteraction {
  id              String            @id @default(cuid())
  roundProgressId String
  questionText    String
  answerText      String?
  audioUrl        String?
  orderIndex      Int
  aiFeedback      String?
  score           Float?
  sentiment       String?
  createdAt       DateTime          @default(now())
  roundProgress   MockRoundProgress @relation(fields: [roundProgressId], references: [id], onDelete: Cascade)
}

enum MockRoundType {
  MCQ
  CODING
  TECH_INTERVIEW
  HR_INTERVIEW
}

enum MockDriveStatus {
  IN_PROGRESS
  PASSED
  FAILED
}

enum MockRoundStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}
